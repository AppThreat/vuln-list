{
  "affected_release": null,
  "package_state": [
    {
      "product_name": "Red Hat Enterprise Linux 6",
      "fix_state": "Not affected",
      "package_name": "kernel",
      "cpe": "cpe:/o:redhat:enterprise_linux:6"
    },
    {
      "product_name": "Red Hat Enterprise Linux 7",
      "fix_state": "Not affected",
      "package_name": "kernel",
      "cpe": "cpe:/o:redhat:enterprise_linux:7"
    },
    {
      "product_name": "Red Hat Enterprise Linux 7",
      "fix_state": "Not affected",
      "package_name": "kernel-rt",
      "cpe": "cpe:/o:redhat:enterprise_linux:7"
    },
    {
      "product_name": "Red Hat Enterprise Linux 8",
      "fix_state": "Not affected",
      "package_name": "kernel",
      "cpe": "cpe:/o:redhat:enterprise_linux:8"
    },
    {
      "product_name": "Red Hat Enterprise Linux 8",
      "fix_state": "Not affected",
      "package_name": "kernel-rt",
      "cpe": "cpe:/o:redhat:enterprise_linux:8"
    },
    {
      "product_name": "Red Hat Enterprise Linux 9",
      "fix_state": "Not affected",
      "package_name": "kernel",
      "cpe": "cpe:/o:redhat:enterprise_linux:9"
    },
    {
      "product_name": "Red Hat Enterprise Linux 9",
      "fix_state": "Not affected",
      "package_name": "kernel-rt",
      "cpe": "cpe:/o:redhat:enterprise_linux:9"
    }
  ],
  "threat_severity": "Moderate",
  "public_date": "2024-02-27T00:00:00Z",
  "bugzilla": {
    "description": "kernel: btrfs: fix race between transaction aborts and fsyncs leading to use-after-free",
    "id": "2266461",
    "url": "https://bugzilla.redhat.com/show_bug.cgi?id=2266461"
  },
  "cvss": {
    "cvss_base_score": "",
    "cvss_scoring_vector": "",
    "status": ""
  },
  "cvss3": {
    "cvss3_base_score": "5.5",
    "cvss3_scoring_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
    "status": "draft"
  },
  "iava": "",
  "cwe": "CWE-416",
  "statement": "",
  "acknowledgement": "",
  "name": "CVE-2021-46958",
  "document_distribution": "",
  "details": [
    "In the Linux kernel, the following vulnerability has been resolved:\nbtrfs: fix race between transaction aborts and fsyncs leading to use-after-free\nThere is a race between a task aborting a transaction during a commit,\na task doing an fsync and the transaction kthread, which leads to an\nuse-after-free of the log root tree. When this happens, it results in a\nstack trace like the following:\nBTRFS info (device dm-0): forced readonly\nBTRFS warning (device dm-0): Skipping commit of aborted transaction.\nBTRFS: error (device dm-0) in cleanup_transaction:1958: errno=-5 IO failure\nBTRFS warning (device dm-0): lost page write due to IO error on /dev/mapper/error-test (-5)\nBTRFS warning (device dm-0): Skipping commit of aborted transaction.\nBTRFS warning (device dm-0): direct IO failed ino 261 rw 0,0 sector 0xa4e8 len 4096 err no 10\nBTRFS error (device dm-0): error writing primary super block to device 1\nBTRFS warning (device dm-0): direct IO failed ino 261 rw 0,0 sector 0x12e000 len 4096 err no 10\nBTRFS warning (device dm-0): direct IO failed ino 261 rw 0,0 sector 0x12e008 len 4096 err no 10\nBTRFS warning (device dm-0): direct IO failed ino 261 rw 0,0 sector 0x12e010 len 4096 err no 10\nBTRFS: error (device dm-0) in write_all_supers:4110: errno=-5 IO failure (1 errors while writing supers)\nBTRFS: error (device dm-0) in btrfs_sync_log:3308: errno=-5 IO failure\ngeneral protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b68: 0000 [#1] PREEMPT SMP DEBUG_PAGEALLOC PTI\nCPU: 2 PID: 2458471 Comm: fsstress Not tainted 5.12.0-rc5-btrfs-next-84 #1\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014\nRIP: 0010:__mutex_lock+0x139/0xa40\nCode: c0 74 19 (...)\nRSP: 0018:ffff9f18830d7b00 EFLAGS: 00010202\nRAX: 6b6b6b6b6b6b6b68 RBX: 0000000000000001 RCX: 0000000000000002\nRDX: ffffffffb9c54d13 RSI: 0000000000000000 RDI: 0000000000000000\nRBP: ffff9f18830d7bc0 R08: 0000000000000000 R09: 0000000000000000\nR10: ffff9f18830d7be0 R11: 0000000000000001 R12: ffff8c6cd199c040\nR13: ffff8c6c95821358 R14: 00000000fffffffb R15: ffff8c6cbcf01358\nFS:  00007fa9140c2b80(0000) GS:ffff8c6fac600000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007fa913d52000 CR3: 000000013d2b4003 CR4: 0000000000370ee0\nDR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\nDR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\nCall Trace:\n? __btrfs_handle_fs_error+0xde/0x146 [btrfs]\n? btrfs_sync_log+0x7c1/0xf20 [btrfs]\n? btrfs_sync_log+0x7c1/0xf20 [btrfs]\nbtrfs_sync_log+0x7c1/0xf20 [btrfs]\nbtrfs_sync_file+0x40c/0x580 [btrfs]\ndo_fsync+0x38/0x70\n__x64_sys_fsync+0x10/0x20\ndo_syscall_64+0x33/0x80\nentry_SYSCALL_64_after_hwframe+0x44/0xae\nRIP: 0033:0x7fa9142a55c3\nCode: 8b 15 09 (...)\nRSP: 002b:00007fff26278d48 EFLAGS: 00000246 ORIG_RAX: 000000000000004a\nRAX: ffffffffffffffda RBX: 0000563c83cb4560 RCX: 00007fa9142a55c3\nRDX: 00007fff26278cb0 RSI: 00007fff26278cb0 RDI: 0000000000000005\nRBP: 0000000000000005 R08: 0000000000000001 R09: 00007fff26278d5c\nR10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000340\nR13: 00007fff26278de0 R14: 00007fff26278d96 R15: 0000563c83ca57c0\nModules linked in: btrfs dm_zero dm_snapshot dm_thin_pool (...)\n---[ end trace ee2f1b19327d791d ]---\nThe steps that lead to this crash are the following:\n1) We are at transaction N;\n2) We have two tasks with a transaction handle attached to transaction N.\nTask A and Task B. Task B is doing an fsync;\n3) Task B is at btrfs_sync_log(), and has saved fs_info-\u003elog_root_tree\ninto a local variable named 'log_root_tree' at the top of\nbtrfs_sync_log(). Task B is about to call write_all_supers(), but\nbefore that...\n4) Task A calls btrfs_commit_transaction(), and after it sets the\ntransaction state to TRANS_STATE_COMMIT_START, an error happens before\nit w\n---truncated---"
  ],
  "references": [
    "https://www.cve.org/CVERecord?id=CVE-2021-46958\nhttps://nvd.nist.gov/vuln/detail/CVE-2021-46958\nhttps://lore.kernel.org/linux-cve-announce/2024022718-CVE-2021-46958-53ff@gregkh/T/#u"
  ]
}